<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#1fc8a9">
    <title>How to start using Gitlab CI</title>
    <link rel="preload" href="/styles.css" as="style">
    <link rel="preload" href="/index.js" as="script">
    <link href="https://andrepolischuk.com/rss.xml" title="Andrey Polischuk" rel="alternate" type="application/rss+xml">
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="/styles.css">
    <link rel="icon" href="/images/favicon48.png" sizes="48x48">
    <meta name="author" content="Andrey Polischuk">
    <meta property="og:site_name" content="Andrey Polischuk">
    <meta property="article:author" content="https://andrepolischuk.com/">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@andrepolischuk">
    <meta name="description" content="Quick start of testing, building and deploying packages or applications with the built-in CI.">
    <meta property="og:title" content="How to start using Gitlab CI">
    <meta property="og:description" content="Quick start of testing, building and deploying packages or applications with the built-in CI.">
    <meta property="og:url" content="https://andrepolischuk.com/how-to-start-using-gitlab-ci/">
    <meta property="og:type" content="article">
    <meta property="og:image" content="https://github.com/andrepolischuk.png">
    <meta name="twitter:image" content="https://github.com/andrepolischuk.png">
  </head>
  <body>
    <header><a href="/">Andrey Polischuk</a>
    </header>
    <article>
      <header>
        <h1>How to start using Gitlab CI</h1>
        <p><em>
            <time>February 1, 2018</time></em></p>
      </header><p>Quick start of testing, building and deploying packages or applications with the built-in CI.</p>
<p>Gitlab has a cool integrated CI/CD service. If you have repositories there, you can automate some infrastructure parts of development workflow out of the box.</p>
<p>For example, you can:</p>
<ul>
<li>Run tests on packages and apps</li>
<li>Publish to npm</li>
<li>Build and deploy apps to multiple environments</li>
<li>Create multi-staging job pipelines</li>
</ul>
<h2>Initial setup</h2>
<p>Let’s test and publish some package to npm in CI. To configure it just add <a href="https://docs.gitlab.com/ee/ci/yaml/README.html#gitlab-ci-yml"><code>.gitlab-ci.yml</code></a> to the root of a repository and push it. And one more thing you need to do is <a href="https://docs.gitlab.com/runner/">configure runners</a> that is used to run jobs.</p>
<p>In a <code>.gitlab-ci.yml</code> file you define set of <a href="https://docs.gitlab.com/ee/ci/yaml/README.html#jobs">jobs</a> you want run in repository.</p>
<pre><code class="language-yaml">image: node:8

test:
  script:
    - npm install
    - npm test
</code></pre>
<p>In this example, runner uses Docker image with node from <a href="https://hub.docker.com/r/library/node/tags/">Docker Hub</a>.</p>
<p>Also you can specify <a href="https://docs.gitlab.com/ee/ci/yaml/README.html#stages">stages</a> to manage the ordering of jobs’ execution. Jobs defined at the same stages run in parallel, jobs defined at the next stage run after successful completion of the previous stage.</p>
<pre><code class="language-yaml">image: node:8

stages:
  - test
  - publish

before_script: npm install

test:
  stage: test
  script: npm test

publish:
  stage: publish
  script: npm publish
</code></pre>
<p>In this example publish job only runs after test succeeds.</p>
<p>For each job you need define a <a href="https://docs.gitlab.com/ee/ci/yaml/README.html#script">shell script</a> or an array of them that are executed.</p>
<pre><code class="language-yaml">test:
  script: npm test

# or

test:
  script:
    - npm run lint
    - npm test
</code></pre>
<h2>Jobs’ execution policy</h2>
<p>Runners execute jobs on each push in all refs by default. You can limit running the specific job by define <code>only</code> or <code>except</code> directives in its configuration.</p>
<pre><code class="language-yaml">publish:
  stage: publish
  only:
    - tags
  script: npm publish
</code></pre>
<p>Now test job runs on each refs, and publish job only runs when tag is pushed. You can set refs to exectute a job using regular expressions or keywords, such a <code>branches</code>, <code>tags</code>, <code>api</code>, <code>schedules</code>, and something else.</p>
<p>Read more about <a href="https://docs.gitlab.com/ee/ci/yaml/README.html#only-and-except-simplified">job policy in Gitlab’s docs</a>.</p>
<h2>Secret tokens</h2>
<p>You can easy automate publishing or deployment workflow with <a href="https://docs.gitlab.com/ee/ci/variables/README.html">CI variables</a>. It allows publish npm packages from gitlab repository to the npm registry by run only <code>npm version</code> command on local machine.</p>
<ol>
<li>
<p>Generate the npm auth token locally by logging onto npm with <code>npm login</code> command. This will save auth token to npm configuration file <code>~/.npmrc</code>:</p>
<pre><code>//registry.npmjs.org/:_authToken=NPM_AUTH_TOKEN
</code></pre>
</li>
<li>
<p>Copy this token and set it in <code>NPM_AUTH_TOKEN</code> variable in project <a href="https://docs.gitlab.com/ee/ci/variables/README.html#secret-variables">secret variables</a>.</p>
</li>
<li>
<p>Configure <code>.gitlab-ci.yml</code> to setting authToken:</p>
<pre><code class="language-yaml">image: node:8

stages:
  - test
  - publish

before_script: npm install

test:
  stage: test
  script:
    - npm run lint
    - npm test

publish:
  stage: publish
  only:
    - tags
  script:
    - echo &quot;//registry.npmjs.org/:_authToken=$NPM_AUTH_TOKEN&quot; &gt; ~/.npmrc
    - npm publish
</code></pre>
</li>
<li>
<p>Add <code>postversion</code> hook to <code>package.json</code> to push the version commit with tags after increasing version:</p>
<pre><code class="language-json">{
  ...
  &quot;scripts&quot;: {
    &quot;test&quot;: &quot;ava&quot;,
    &quot;postversion&quot;: &quot;git push --follow-tags&quot;
  },
  ...
}
</code></pre>
</li>
</ol>
<p>Now when you’re going to publish new release, run <code>npm version</code>. This will update the <code>package.json</code> version, create commit, push it with tags. When tests succeeds, CI will automatically publish this version to npm.</p>
<p>Also you can use variables to store SSH keys that using for deployment to stage or production.</p>
<ol>
<li>
<p>Generate a new SSH keys locally.</p>
<pre><code class="language-sh">ssh-keygen -t rsa -b 4096
</code></pre>
</li>
<li>
<p>Copy the public key to servers you’re going to deploy from CI.</p>
</li>
<li>
<p>Copy the private key and add it as <code>SSH_PRIVATE_KEY</code> secret variable to project.</p>
</li>
<li>
<p>Add the private key to get access to servers in CI:</p>
<pre><code class="language-yaml">image: node:8

stages:
  - test
  - stage

before_script: npm install

test:
  stage: test
  script:
    - npm run lint
    - npm test

deploy_stage:
  stage: stage
  only:
    - tags
  script:
    - mkdir -p ~/.ssh
    - echo &quot;$SSH_PRIVATE_KEY&quot; | tr -d '\r' &gt; ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H stage.awesome.app &gt;&gt; ~/.ssh/known_hosts
    - npm run dist
    - rsync -rpl ./dist/ stage.awesome.app:/dists/$CI_COMMIT_TAG/
</code></pre>
</li>
<li>
<p>Also add <code>postversion</code> hook to application <code>package.json</code> as in the previous example.</p>
</li>
</ol>
<p>In this case, when you run <code>npm version</code> command, runner tests the new version of application and then automatically deploys it to stage server.</p>
<p>Read more about <a href="https://docs.gitlab.com/ee/ci/ssh_keys/README.html">using SSH keys</a> with Gitlab CI.</p>
<h2>Manual jobs</h2>
<p>Next stage jobs run automatically by default after all previous jobs have passed. But you can execute jobs manually by using <a href="https://docs.gitlab.com/ee/ci/yaml/README.html#when"><code>when</code> directive</a>.</p>
<pre><code class="language-yaml">deploy_stage:
  stage: stage
  only:
    - tags
  when: manual
  script:
    - mkdir -p ~/.ssh
    - echo &quot;$SSH_PRIVATE_KEY&quot; | tr -d '\r' &gt; ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H stage.awesome.app &gt;&gt; ~/.ssh/known_hosts
    - npm run dist
    - rsync -rpl ./dist/ stage.awesome.app:/dists/$CI_COMMIT_TAG/
</code></pre>
<p>Following this configuration, deploy job needs to be started by a user <a href="https://docs.gitlab.com/ee/ci/pipelines.html#manual-actions-from-the-pipeline-graph">from pipeline</a>.</p>
<h2>Caching</h2>
<p>If you build or compile package before publishing, you’ll need install dependencies before running every job. Let’s speed up testing and publishing. You can specify <code>cache</code> directive with list of files which should be cached between jobs. If there are a lot of jobs, you reduce extraneous downloading the dependencies for each job. By default Gitlab doesn’t cache files untracked by git.</p>
<p>Add <code>node_modules</code> directory to caching list:</p>
<pre><code class="language-yaml">image: node:8

stages:
  - test
  - publish

cache:
  paths:
    - node_modules/

test:
  stage: test
  script:
    - npm install
    - npm run lint
    - npm test

publish:
  stage: publish
  only:
    - tags
  script:
    - echo &quot;//registry.npmjs.org/:_authToken=$NPM_AUTH_TOKEN&quot; &gt; ~/.npmrc
    - npm publish
</code></pre>
<p>Next step, enable per-branch caching by using <code>cache:key</code> directive. It allows cache dependencies solely between jobs with the same ref name. And all jobs run with the same dependencies’ tree.</p>
<pre><code class="language-yaml">image: node:8

stages:
  - test
  - publish

test:
  stage: test
  cache:
    key: &quot;$CI_COMMIT_REF_NAME:node_modules&quot;
    paths:
      - node_modules/
    policy: push
  script:
    - npm install
    - npm run lint
    - npm test

publish:
  stage: publish
  cache:
    key: &quot;$CI_COMMIT_REF_NAME:node_modules&quot;
    paths:
      - node_modules/
    policy: pull
  only:
    - tags
  script:
    - echo &quot;//registry.npmjs.org/:_authToken=$NPM_AUTH_TOKEN&quot; &gt; ~/.npmrc
    - npm publish
</code></pre>
<p>In this example, test job installs dependencies and pushes them to cache. Publish job pulls dependencies, compiles and publishes results.</p>
<p>Read more about <a href="https://docs.gitlab.com/ee/ci/yaml/README.html#cache">caching in Gitlab’s docs</a>.</p>
<h2>Pages for API docs</h2>
<p>Another interesting task you can do in CI is a publishing docs for package to <a href="https://docs.gitlab.com/ee/user/project/pages/">Gitlab pages</a>. Add job called <code>pages</code> to <code>.gitlab-ci.yml</code> file with <a href="https://docs.gitlab.com/ee/ci/yaml/README.html#artifacts"><code>artifacts</code> directive</a> to tell runner that this job creates artifacts.</p>
<pre><code class="language-yaml">image: node:8

stages:
  - test
  - publish
  - pages

...

pages:
  stage: docs
  cache:
    key: &quot;$CI_COMMIT_REF_NAME:node_modules&quot;
    paths:
      - node_modules/
    policy: pull
  only:
    - tags
  script:
    - npm run docs
  artifacts:
    paths:
      - public
</code></pre>
<p>With this configuration <code>npm run docs</code> command builds the site with API documentations to artifacts <code>./public</code> directory. This directory will be automatically deployed to Gitlab pages when job completed.</p>
<h2>Wrapping up</h2>
<p>That’s it. I reviewed the basics of usage integrated Gitlab CI for testing, building or deploying packages or applications. I hope you’ll find something new for yourself.</p>
<p>Read the CI docs to gain a deeper understanding how it works:</p>
<ul>
<li><a href="https://docs.gitlab.com/ee/ci/README.html">GitLab Continuous Integration</a></li>
<li><a href="https://docs.gitlab.com/ee/ci/pipelines.html">Introduction to pipelines and jobs</a></li>
<li><a href="https://docs.gitlab.com/ee/ci/variables/README.html">GitLab CI/CD Variables</a></li>
<li><a href="https://docs.gitlab.com/ee/ci/runners/README.html">Configuring GitLab Runners</a></li>
<li><a href="https://docs.gitlab.com/ce/ci/docker/using_docker_images.html">Using Docker images</a></li>
</ul>

      <footer>
        <nav>
          <ul>
            <li><a href="/2018-s-to-do/">←&nbsp;2018’s to-do</a>
            </li>
            <li><a href="/commenting-a-code/">Commenting a code&nbsp;→</a>
            </li>
          </ul>
        </nav>
      </footer>
    </article>
    <script async="" src="/index.js"></script>
  </body>
</html>