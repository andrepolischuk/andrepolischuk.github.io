<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>How use Renovate Bot on self-hosted GitLab – Andrey Polischuk</title>
    <link rel="preload" href="/styles.css" as="style">
    <link rel="preload" href="/index.js" as="script">
    <link href="https://polischuk.xyz/rss.xml" title="Blog by Andrey Polischuk" rel="alternate" type="application/rss+xml">
    <link rel="stylesheet" href="/styles.css">
    <meta name="author" content="Andrey Polischuk">
    <meta property="og:site_name" content="Blog by Andrey Polischuk">
    <meta property="article:author" content="https://polischuk.xyz/">
    <meta name="twitter:card" content="summary">
    <meta name="description" content="There is no built-in Renovate Bot on a self-hosted GitLab. What can we do to set it up and enjoy all the benefits of automatic dependency updates?">
    <meta property="article:published_time" content="1713744000">
    <meta property="og:title" content="How use Renovate Bot on self-hosted GitLab – Andrey Polischuk">
    <meta property="og:description" content="There is no built-in Renovate Bot on a self-hosted GitLab. What can we do to set it up and enjoy all the benefits of automatic dependency updates?">
    <meta property="og:url" content="https://polischuk.xyz/how-use-renovate-bot-on-self-hosted-gitlab/">
    <meta property="og:type" content="article">
    <meta property="og:image" content="https://github.com/andrepolischuk.png">
    <meta name="twitter:image" content="https://github.com/andrepolischuk.png">
  </head>
  <body>
    <article>
      <header>
        <h1>How use Renovate Bot on self-hosted GitLab</h1>
        <p>
          <time>April 22, 2024</time>
        </p>
      </header><p>There is no built-in <a href="https://github.com/renovatebot/renovate">Renovate Bot</a> on a self-hosted GitLab. What can we do to set it up and enjoy all the benefits of automatic dependency updates?</p>
<p>Renovate Bot is an automated tool designed to update software dependencies. It checks new versions of libraries and packages used in your project and automatically creates merge requests for their updates. This ensures a safer and up-to-date state of dependencies, minimizing the risks associated with vulnerabilities in old versions.</p>
<p>For self-hosted repositories of frontend applications, Renovate Bot offers the following options:</p>
<ul>
<li>Use the npm package <a href="https://www.npmjs.com/package/renovate"><code>renovate</code></a>.</li>
<li>Use the Docker image <a href="https://hub.docker.com/r/renovate/renovate/"><code>renovate/renovate</code></a>.</li>
<li>Use <a href="https://gitlab.com/renovate-bot/renovate-runner/">Renovate runner</a> for GitLab.</li>
<li>Deploy Renovate <a href="https://github.com/mend/renovate-ce-ee">Community Edition or Enterprise Edition</a> on your own.</li>
</ul>
<p>The first option is not suitable for us because it’s designed for the npm projects, and we would like a more universal approach. The last option is also not suitable because it would require maintaining a separate Renovate instance. We also do not want to maintain a separate runner, so we will use the Docker image that can be run on any existing runner.</p>
<h2><a href="#step-1-repository-configuration" data-anchor>#</a>Step #1: Repository configuration</h2><p>Create a file <a href="https://docs.renovatebot.com/configuration-options/"><code>renovate.json</code></a> in the root of your repository. I recommend adding the following options:</p>
<ul>
<li><a href="https://docs.renovatebot.com/configuration-options/#reviewers"><code>reviewers</code></a> – a list of developers who should be aware of updates and on whom merge requests with updates will be assigned.</li>
<li><a href="https://docs.renovatebot.com/configuration-options/#minimumreleaseage"><code>minimumReleaseAge</code></a> – npm packages can be unpublished within 72 hours, so it’s worth waiting this time before updating to a new version of the package.</li>
<li><a href="https://docs.renovatebot.com/configuration-options/#prhourlylimit"><code>prHourlyLimit</code></a> – disable the limit of 2 updates per hour.</li>
<li><a href="https://docs.renovatebot.com/configuration-options/#prconcurrentlimit"><code>prConcurrentLimit</code></a> – disable the limit of 10 concurrent updates.</li>
<li><a href="https://docs.renovatebot.com/configuration-options/#addlabels"><code>addLabels</code></a> – a list of labels for merge requests with the update type.</li>
<li><a href="https://docs.renovatebot.com/configuration-options/#automerge"><code>automerge</code></a> – if your code is typed, sufficiently covered with static checks and tests, it makes sense to enable auto-merge for <code>patch</code> and <code>minor</code> updates that does not break packages API. Also exclude auto-merging for unstable 0.x updates by <code>matchCurrentVersion</code>.</li>
</ul>
<p>Final settings:</p>
<pre><code class="language-json">{
  &quot;$schema&quot;: &quot;https://docs.renovatebot.com/renovate-schema.json&quot;,
  &quot;minimumReleaseAge&quot;: &quot;3 days&quot;,
  &quot;reviewers&quot;: [&quot;andrepolischuk&quot;, &quot;unicorn&quot;],
  &quot;prHourlyLimit&quot;: 0,
  &quot;prConcurrentLimit&quot;: 0,
  &quot;packageRules&quot;: [
    {
      &quot;matchUpdateTypes&quot;: [&quot;patch&quot;],
      &quot;addLabels&quot;: [&quot;dependencies&quot;, &quot;patch&quot;]
    },
    {
      &quot;matchUpdateTypes&quot;: [&quot;minor&quot;],
      &quot;addLabels&quot;: [&quot;dependencies&quot;, &quot;minor&quot;]
    },
    {
      &quot;matchUpdateTypes&quot;: [&quot;major&quot;],
      &quot;addLabels&quot;: [&quot;dependencies&quot;, &quot;major&quot;]
    },
    {
      &quot;matchUpdateTypes&quot;: [&quot;patch&quot;, &quot;minor&quot;],
      &quot;matchCurrentVersion&quot;: &quot;!/^0/&quot;,
      &quot;automerge&quot;: true
    }
  ]
}
</code></pre>
<p>If you use <a href="https://docs.gitlab.com/ee/user/project/codeowners/index.html#codeowners-file"><code>CODEOWNERS</code></a> file to describe those responsible for your code, you don’t need to directly specify reviewers in the configuration, but instead use the <a href="https://docs.renovatebot.com/configuration-options/#reviewersfromcodeowners"><code>reviewersFromCodeOwners</code></a> setting to pull them from the file.</p>
<pre><code class="language-json">{
  &quot;$schema&quot;: &quot;https://docs.renovatebot.com/renovate-schema.json&quot;,
  &quot;minimumReleaseAge&quot;: &quot;3 days&quot;,
  &quot;reviewersFromCodeOwners&quot;: true,
  ...
}
</code></pre>
<h2><a href="#step-2-gitlab-ci-pipeline-configuration" data-anchor>#</a>Step #2: GitLab CI pipeline configuration</h2><p>Add a stage to your pipeline that uses Renovate Bot Docker image. Also, add environment settings so that Renovate Bot can use the API of your self-hosted GitLab:</p>
<ul>
<li><a href="https://docs.renovatebot.com/self-hosted-configuration/#platform"><code>RENOVATE_PLATFORM</code></a> – platform type, in our case – <code>gitlab</code>.</li>
<li><a href="https://docs.renovatebot.com/self-hosted-configuration/#endpoint"><code>RENOVATE_ENDPOINT</code></a> – entry point of the GitLab API.</li>
<li><a href="https://docs.renovatebot.com/self-hosted-configuration/#token"><code>RENOVATE_TOKEN</code></a> – <a href="https://docs.gitlab.com/ee/user/group/settings/group_access_tokens.html">group</a> or <a href="https://docs.gitlab.com/ee/user/project/settings/project_access_tokens.html">project</a> access token for the repository.</li>
<li><a href="https://docs.renovatebot.com/self-hosted-configuration/#autodiscover"><code>RENOVATE_AUTODISCOVER</code></a> – automatic repository discovery – <code>true</code>.</li>
</ul>
<p>Final pipeline:</p>
<pre><code class="language-yml">stages:
  ...
  - update

...

update deps:
  stage: update
  image: docker.io/renovate/renovate:37-slim
  variables:
    RENOVATE_PLATFORM: 'gitlab'
    RENOVATE_ENDPOINT: $GL_API_URL
    RENOVATE_TOKEN: $GL_TOKEN
    RENOVATE_AUTODISCOVER: 'true'
  script:
    - renovate
</code></pre>
<h2><a href="#step-3-creating-a-schedule" data-anchor>#</a>Step #3: Creating a schedule</h2><p>Dependency updates are released continuously. To reduce noise, add a schedule for running Renovate Bot, for example, once a week before the start of sprint. You will receive a list of updates and will be able to plan critical updates for the current sprint.</p>
<p>GitLab has <a href="https://docs.gitlab.com/ee/ci/pipelines/schedules.html">scheduled pipelines</a> where you can set up a schedule for checking updates. The schedule is set in <code>crontab</code> file format.</p>
<pre><code class="language-crontab">00 9 * * 1
</code></pre>
<p>Updates with this schedule will be run every Monday at 9 am.</p>
<p>Also, add a variable with the task type, for example, <code>SCHEDULE_TYPE</code>, so that it can be used to trigger updates on GitLab CI.</p>
<pre><code class="language-yml">update deps:
  stage: update
  image: docker.io/renovate/renovate:37-slim
  variables:
    RENOVATE_PLATFORM: 'gitlab'
    RENOVATE_ENDPOINT: $GL_API_URL
    RENOVATE_TOKEN: $GL_TOKEN
    RENOVATE_AUTODISCOVER: 'true'
  rules:
    - if: '$SCHEDULE_TYPE == &quot;weekly&quot;'
  script:
    - renovate
</code></pre>
<h2><a href="#bonus" data-anchor>#</a>Bonus</h2><p>This configuration is not dependent on language and can be used not for frontend projects with npm but also for the rest located on your GitLab.</p>
<p>For further reading, check the <a href="https://docs.renovatebot.com">Renovate Bot</a> documentation.</p>

      <footer><a href="/">← Home</a></footer>
    </article>
    <script async="" src="/index.js"></script>
  </body>
</html>